# The manifest for the "api" service.
# Load Balanced Web Service
# https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/

name: api
type: Load Balanced Web Service

http:
  path: '/'
  healthcheck: '/v1/health'

image:
  build:
    context: .
    dockerfile: backend/api/Dockerfile
  port: 8000

cpu: 256
memory: 512
count: 1
exec: true

network:
  connect: true

# ---------------------------------------------------------
# LLM Runtime Configuration (Bedrock â€“ Dev Default)
# ---------------------------------------------------------

variables:
  AWS_REGION: us-east-1
  LLM_PROVIDER: bedrock
  LLM_MODEL_IDENTIFIER: arn:aws:bedrock:us-east-1:456462539706:inference-profile/us.meta.llama3-1-8b-instruct-v1:0
  LLM_TIMEOUT_SECONDS: "120"
  LLM_TRACE_ENABLED: "0"

# ---------------------------------------------------------
# IAM Permissions for ECS Task Role
# ---------------------------------------------------------

permissions:
  policies:
    - policy_name: BedrockInvokeModel
      policy_document:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
            Resource:
              - arn:aws:bedrock:us-east-1:456462539706:inference-profile/us.meta.llama3-1-8b-instruct-v1:0

# ---------------------------------------------------------
# Optional environment-specific overrides
# ---------------------------------------------------------
#
# environments:
#   dev:
#     count: 2
#   prod:
#     variables:
#       LLM_TRACE_ENABLED: "0"
